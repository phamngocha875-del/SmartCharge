<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCharge Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .screen {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-enter {
            animation: slideUp 0.3s ease-out forwards;
        }
        .modal-exit {
            animation: slideDown 0.3s ease-in forwards;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        @keyframes slideDown {
            from { transform: translateY(0); }
            to { transform: translateY(100%); }
        }
        .progress-bar-fill {
            transition: width 1s linear;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .rating-star {
            cursor: pointer;
            transition: color 0.2s;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-sm h-[800px] max-h-[90vh] bg-gray-50 rounded-3xl shadow-2xl overflow-hidden relative flex flex-col">

        <!-- ===== Main Content Area ===== -->
        <main class="flex-1 overflow-y-auto no-scrollbar">
            <!-- All screens will be rendered here by JavaScript -->
        </main>

        <!-- ===== Bottom Navigation ===== -->
        <nav id="bottom-nav" class="bg-white border-t border-gray-200 grid grid-cols-4 gap-2 px-4 py-2">
            <button id="nav-home" class="flex flex-col items-center justify-center text-green-600 font-medium text-xs py-1 rounded-lg" onclick="renderHomeScreen()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span>Trang chủ</span>
            </button>
            <button id="nav-history" class="flex flex-col items-center justify-center text-gray-500 hover:text-green-600 font-medium text-xs py-1 rounded-lg" onclick="renderHistoryScreen()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 6v6l4 2"/><circle cx="12" cy="12" r="10"/></svg>
                <span>Lịch sử</span>
            </button>
            <button id="nav-wallet" class="flex flex-col items-center justify-center text-gray-500 hover:text-green-600 font-medium text-xs py-1 rounded-lg" onclick="renderWalletScreen()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
                <span>Ví Wallet</span>
            </button>
            <button id="nav-profile" class="flex flex-col items-center justify-center text-gray-500 hover:text-green-600 font-medium text-xs py-1 rounded-lg" onclick="renderProfileScreen()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span>Hồ sơ</span>
            </button>
        </nav>
    </div>

    <script>
        const mainContent = document.querySelector('main');
        const bottomNav = document.getElementById('bottom-nav');

        // --- MOCK DATA ---
        const mockStations = {
            "st_cl": { name: "Charge+ Chùa Láng", time: 30, cost: 65000, rating: 4.5, address: "120 Chùa Láng, Đống Đa", distance: "500 m", travelTime: "2 phút", type: "cheapest", amenities: [{type:'cafe', name: 'Aha Cafe'}, {type:'food', name: 'Bún chả Sinh Từ'}] },
            "st_nct": { name: "EBOOST Vincom NCT", time: 25, cost: 75000, rating: 4.8, address: "54A Nguyễn Chí Thanh, Đống Đa", distance: "1.5 km", travelTime: "5 phút", type: "recommended", amenities: [{type:'food', name: 'Kichi-Kichi'}, {type:'entertainment', name: 'CGV Cinema'}] },
            "st_lotte": { name: "EV One Lotte Center", time: 35, cost: 85000, rating: 4.7, address: "54 Liễu Giai, Ba Đình", distance: "2.5 km", travelTime: "8 phút", type: "none", amenities: [{type:'hotel', name: 'Lotte Hotel'}, {type:'food', name: 'Top of Hanoi'}] },
            "st_jw": { name: "Porsche Charging JW Marriott", time: 20, cost: 150000, rating: 4.9, address: "8 Đỗ Đức Dục, Nam Từ Liêm", distance: "4.0 km", travelTime: "12 phút", type: "fastest", amenities: [{type:'hotel', name: 'JW Marriott'}, {type:'cafe', name: 'The Lounge'}] },
        };
        
        const mockJourneys = [
            {
                id: 'journey01',
                type: 'optimal',
                name: 'Hành trình Tối ưu nhất',
                totalTime: 1985,
                totalCost: 1850000,
                stops: 3,
                steps: [
                    { type: 'drive', duration: 300, from: 'Hà Nội', to: 'TP. Vinh, Nghệ An' },
                    { type: 'charge', stationId: 'st_vinh' },
                    { type: 'drive', duration: 480, from: 'TP. Vinh', to: 'TP. Đà Nẵng' },
                    { type: 'charge', stationId: 'st_danang' },
                    { type: 'drive', duration: 540, from: 'TP. Đà Nẵng', to: 'TP. Nha Trang, Khánh Hòa' },
                    { type: 'charge', stationId: 'st_nhatrang' },
                    { type: 'drive', duration: 420, from: 'TP. Nha Trang', to: 'TP. Hồ Chí Minh' }
                ]
            },
            {
                id: 'journey02',
                type: 'cheapest',
                name: 'Hành trình Tiết kiệm nhất',
                totalTime: 2200,
                totalCost: 1550000,
                stops: 4,
                steps: [ /* Incomplete for demo */ ]
            },
            {
                id: 'journey03',
                type: 'fastest',
                name: 'Hành trình Nhanh nhất',
                totalTime: 1850,
                totalCost: 2100000,
                stops: 3,
                steps: [ /* Incomplete for demo */ ]
            }
        ];
        
        mockStations["st_vinh"] = { name: "ECharge Vinh", time: 45, cost: 110000, rating: 4.6, address: "100 Trần Phú, TP. Vinh", amenities: [{type:'food', name: 'Cháo lươn bà Ngọ'}, {type:'hotel', name: 'Khách sạn Mường Thanh'}] };
        mockStations["st_danang"] = { name: "Da Nang PowerUp", time: 50, cost: 135000, rating: 4.9, address: "255 Nguyễn Văn Linh, Đà Nẵng", amenities: [{type:'food', name: 'Mì Quảng Bà Mua'}, {type:'entertainment', name: 'Cầu Rồng'}] };
        mockStations["st_nhatrang"] = { name: "EVNCharge Nha Trang", time: 40, cost: 105000, rating: 4.7, address: "86 Trần Phú, Nha Trang", amenities: [{type:'cafe', name: 'Sailing Club'}, {type:'hotel', name: 'InterContinental Nha Trang'}] };
        
        const mockFavoriteStations = ['st_nct', 'st_lotte'];
        const mockTravelSuggestions = [
            { title: 'Khám phá Đà Nẵng', description: 'Mùa hè sôi động', image: 'https://placehold.co/300x200/3b82f6/ffffff?text=Đà+Nẵng' },
            { title: 'Chào Sài Gòn', description: 'Nhịp sống không ngủ', image: 'https://placehold.co/300x200/ef4444/ffffff?text=Sài+Gòn' },
            { title: 'Mộng mơ Đà Lạt', description: 'Không khí se lạnh', image: 'https://placehold.co/300x200/10b981/ffffff?text=Đà+Lạt' }
        ];

        // --- APP STATE ---
        const appState = {
            currentScreen: 'home',
            history: {
                activeTab: 'history'
            },
            request: {
                currentSOC: 90, 
                startLocation: "91 Chùa Láng, Hà Nội",
                destination: "",
            },
            booking: {
                journey: null,
                station: null,
                timeSlot: null,
                currentStepIndex: -1,
            },
            nearby: {
                selectedCategory: 'recommended',
                selectedStationId: null,
            },
            user: {
                name: "Nguyễn Văn A",
                email: "nguyenvana@email.com",
                phone: "0912345678",
                cars: [
                    { id: 'car1', name: 'BYD Atto 3', active: true },
                    { id: 'car3', name: 'Kia EV6', active: false },
                ]
            },
            simulationInterval: null,
        };
        
        // --- HELPER FUNCTIONS ---
        const updateNavActiveState = (activeScreen) => {
             bottomNav.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('text-green-600');
                btn.classList.add('text-gray-500');
            });
            const activeBtn = document.getElementById(`nav-${activeScreen}`);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-500');
                activeBtn.classList.add('text-green-600');
            }
        }

        // --- TEMPLATES / RENDER FUNCTIONS ---
        const renderHomeScreen = () => {
            appState.currentScreen = 'home';
            updateNavActiveState('home');
            bottomNav.classList.remove('hidden');
            const activeCar = appState.user.cars.find(car => car.active);

            const favoriteStationsHTML = mockFavoriteStations.map(stationId => {
                const station = mockStations[stationId];
                return `
                    <div class="bg-white p-3 rounded-xl border flex-shrink-0 w-60 cursor-pointer shadow-sm hover:shadow-md transition-shadow" onclick="renderDetailsScreen('${stationId}')">
                        <p class="font-semibold truncate">${station.name}</p>
                        <p class="text-xs text-gray-500 truncate">${station.address}</p>
                    </div>
                `;
            }).join('');

            const travelSuggestionsHTML = mockTravelSuggestions.map(suggestion => `
                <div class="relative rounded-2xl overflow-hidden flex-shrink-0 w-48 h-32 text-white cursor-pointer shadow-lg" onclick="renderJourneyPlannerScreen()">
                    <img src="${suggestion.image}" class="absolute inset-0 w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                    <div class="relative p-3 h-full flex flex-col justify-end">
                        <p class="font-bold">${suggestion.title}</p>
                        <p class="text-xs opacity-90">${suggestion.description}</p>
                    </div>
                </div>
            `).join('');

            mainContent.innerHTML = `
                <div id="homeScreen" class="screen flex flex-col h-full">
                    <header class="p-4">
                        <div class="flex items-center justify-between">
                             <h2 class="text-2xl font-bold text-gray-800">Xin chào, ${appState.user.name.split(' ').pop()}!</h2>
                             <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center" onclick="renderProfileScreen()">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                             </div>
                        </div>
                        <div class="mt-4 bg-white p-4 rounded-2xl border border-gray-200 shadow-sm">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-lg">${activeCar.name}</p>
                                    <p class="text-sm text-gray-500">Pin hiện tại</p>
                                </div>
                                <p class="text-2xl font-bold text-green-600">${appState.request.currentSOC}%</p>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                                <div class="bg-green-600 h-2.5 rounded-full" style="width: ${appState.request.currentSOC}%"></div>
                            </div>
                        </div>
                    </header>
                    <div class="flex-1 overflow-y-auto px-4 space-y-6">
                        <div class="space-y-4">
                           <div class="bg-green-600 text-white p-5 rounded-2xl cursor-pointer hover:bg-green-700 transition-all flex justify-between items-center" onclick="renderNearbyStationsScreen()">
                                <div>
                                    <h3 class="text-xl font-bold">Tìm trạm sạc ngay</h3>
                                    <p class="text-sm opacity-80 mt-1">Khám phá trạm sạc gần bạn.</p>
                                </div>
                                <span class="text-2xl font-semibold">→</span>
                            </div>
                            <div class="bg-blue-600 text-white p-5 rounded-2xl cursor-pointer hover:bg-blue-700 transition-all flex justify-between items-center" onclick="renderJourneyPlannerScreen()">
                                 <div>
                                    <h3 class="text-xl font-bold">Lên hành trình sạc</h3>
                                    <p class="text-sm opacity-80 mt-1">Cho các chuyến đi xa, liên tỉnh.</p>
                                </div>
                                <span class="text-2xl font-semibold">→</span>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800 mb-3">Trạm sạc yêu thích</h3>
                            <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                                ${favoriteStationsHTML}
                            </div>
                        </div>
                        <div>
                             <h3 class="font-bold text-lg text-gray-800 mb-3">Gợi ý hành trình</h3>
                             <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                                ${travelSuggestionsHTML}
                             </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderJourneyPlannerScreen = () => {
             bottomNav.classList.add('hidden');
             mainContent.innerHTML = `
                <div id="journeyPlannerScreen" class="screen flex flex-col h-full">
                     <header class="flex items-center p-4">
                        <button onclick="renderHomeScreen()" class="p-2 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                        <h2 class="text-xl font-bold text-center flex-1">Lên Kế hoạch Hành trình</h2>
                        <div class="w-8"></div>
                    </header>
                    <div class="flex-1 bg-gray-200 m-4 rounded-2xl relative overflow-hidden flex items-center justify-center">
                        <img src="https://placehold.co/400x600/e2e8f0/64748b?text=Bản+đồ+Việt+Nam" class="w-full h-full object-cover opacity-50" alt="Bản đồ">
                    </div>
                    <div class="p-6 bg-white rounded-t-3xl shadow-[0_-10px_30px_-15px_rgba(0,0,0,0.1)]">
                         <div class="space-y-4">
                            <div>
                                <label class="text-sm font-medium text-gray-600">Điểm khởi hành</label>
                                <input type="text" value="${appState.request.startLocation}" class="w-full p-3 mt-1 bg-gray-100 border border-gray-200 rounded-lg text-gray-700" readonly>
                            </div>
                            <div class="relative">
                                <label class="text-sm font-medium text-gray-600">Bạn muốn đến đâu?</label>
                                <input id="destination-input" type="text" placeholder="VD: TP. Hồ Chí Minh" class="w-full p-3 mt-1 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" onkeyup="handleDestinationInput(this.value)">
                                <div id="destination-suggestions" class="absolute z-10 w-full bg-white border rounded-lg mt-1 shadow-lg hidden bottom-full mb-2"></div>
                            </div>
                         </div>
                        <button onclick="openJourneyModal()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl text-lg hover:bg-blue-700 transition-colors mt-6">
                            Lên hành trình
                        </button>
                    </div>
                </div>
            `;
        }

        const mockDestinations = [ "TP. Hồ Chí Minh", "TP. Đà Nẵng", "TP. Nha Trang" ];

        const handleDestinationInput = (value) => {
            const suggestionsContainer = document.getElementById('destination-suggestions');
            if (!value) { suggestionsContainer.classList.add('hidden'); return; }
            const filtered = mockDestinations.filter(d => d.toLowerCase().includes(value.toLowerCase()));
            if (filtered.length > 0) {
                suggestionsContainer.innerHTML = filtered.map(d => `<div class="p-3 hover:bg-gray-100 cursor-pointer" onclick="selectDestination('${d}')">${d}</div>`).join('');
                suggestionsContainer.classList.remove('hidden');
            } else { suggestionsContainer.classList.add('hidden'); }
        };

        const selectDestination = (destination) => {
            document.getElementById('destination-input').value = destination;
            appState.request.destination = destination;
            document.getElementById('destination-suggestions').classList.add('hidden');
        };

        const openJourneyModal = () => {
            appState.request.destination = document.getElementById('destination-input').value || appState.request.destination;
            if (!appState.request.destination) { alert("Vui lòng nhập điểm đến của bạn."); return; }
            findJourneys();
        };

        const findJourneys = () => { 
            // Simulate a short delay for searching
            setTimeout(renderResultsScreen, 350); 
        };

        const renderResultsScreen = () => {
            bottomNav.classList.add('hidden');

            const journeyTypes = {
                optimal: {
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`,
                    color: 'blue'
                },
                cheapest: {
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
                    color: 'green'
                },
                fastest: {
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>`,
                    color: 'orange'
                }
            };
            
            const journeyCardsHTML = mockJourneys.map(journey => {
                const hours = Math.floor(journey.totalTime / 60);
                const minutes = journey.totalTime % 60;
                const typeInfo = journeyTypes[journey.type] || journeyTypes.optimal;

                return `
                    <div class="bg-white p-4 rounded-2xl border-l-4 border-${typeInfo.color}-500 shadow-md cursor-pointer hover:shadow-lg transition-shadow" onclick="renderJourneyDetailsScreen('${journey.id}')">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 flex items-center justify-center bg-${typeInfo.color}-100 text-${typeInfo.color}-600 rounded-full">
                                    ${typeInfo.icon}
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800 text-lg">${journey.name}</h3>
                                    <p class="text-sm text-gray-500">${journey.stops} điểm dừng</p>
                                </div>
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="m9 18 6-6-6-6"/></svg>
                        </div>
                        <div class="border-t my-3"></div>
                        <div class="flex justify-between items-center text-sm">
                            <div class="flex items-center gap-1.5 text-gray-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                                <span>~${hours}h ${minutes}m</span>
                            </div>
                            <p class="font-bold text-lg text-${typeInfo.color}-600">${journey.totalCost.toLocaleString('vi-VN')}đ</p>
                        </div>
                    </div>
                `;
            }).join('');

            mainContent.innerHTML = `
                <div id="resultsScreen" class="screen p-4 bg-gray-100 h-full">
                     <header class="flex items-center mb-4">
                        <button onclick="renderJourneyPlannerScreen()" class="p-2 rounded-full hover:bg-gray-200"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                        <h2 class="text-xl font-bold text-center flex-1">Đề xuất Hành trình</h2>
                        <div class="w-8"></div>
                    </header>
                    <div class="mt-4 space-y-4"> ${journeyCardsHTML} </div>
                </div>
            `;
        };

        const renderJourneyDetailsScreen = (journeyId) => {
            appState.booking.journey = mockJourneys.find(j => j.id === journeyId);
            const journey = appState.booking.journey;
            let cumulativeTime = 0;
            const startTime = new Date();

            const amenityIcons = {
                food: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M3 21h18v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2z"/><path d="M12 11a4 4 0 0 0-4 4v2h8v-2a4 4 0 0 0-4-4z"/><path d="M12 2v2"/><path d="M5 4.55a4 4 0 0 0-2 3.45v2h4v-2a4 4 0 0 0-2-3.45z"/><path d="M19 4.55a4 4 0 0 1 2 3.45v2h-4v-2a4 4 0 0 1 2-3.45z"/></svg>`,
                cafe: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-700"><path d="M10 21h4v-2a2 2 0 0 0-2-2h0a2 2 0 0 0-2 2v2z"/><path d="M20 8h-2.5a2.5 2.5 0 0 1 0-5h0A2.5 2.5 0 0 1 20 8z"/><path d="M4 8a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v8a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8z"/></svg>`,
                hotel: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M10 22v-6.57"/><path d="M12 11h.01"/><path d="M12 7h.01"/><path d="M14 15.43V22"/><path d="M15 4H9a2 2 0 0 0-2 2v12h10V6a2 2 0 0 0-2-2z"/><path d="M21 17h-2a2 2 0 0 0-2 2v3h4v-5z"/><path d="M3 17h2a2 2 0 0 1 2 2v3H3v-5z"/></svg>`,
                entertainment: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-500"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>`
            };
            
            const stepsHTML = journey.steps.map(step => {
                const driveHours = Math.floor(step.duration / 60);
                const driveMinutes = step.duration % 60;
                cumulativeTime += step.duration;
                const arrivalTime = new Date(startTime.getTime() + cumulativeTime * 60000);
                const arrivalTimeString = arrivalTime.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

                if (step.type === 'drive') {
                    return `
                    <li class="mb-10 ml-6">            
                        <span class="absolute flex items-center justify-center w-6 h-6 bg-blue-100 rounded-full -left-3 ring-8 ring-white">
                            <svg class="w-3.5 h-3.5 text-blue-800" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><path d="M7 17h10"/><path d="M6 11h2"/><path d="M16 11h2"/><circle cx="8" cy="17" r="2"/><circle cx="16" cy="17" r="2"/></svg>
                        </span>
                        <h3 class="flex items-center mb-1 text-lg font-semibold text-gray-900">Lái xe tới ${step.to}</h3>
                        <time class="block mb-2 text-sm font-normal leading-none text-gray-400">Dự kiến: ${driveHours}h ${driveMinutes}m - Tới nơi lúc ${arrivalTimeString}</time>
                    </li>
                    `;
                } else { // charge
                    const station = mockStations[step.stationId];
                    cumulativeTime += station.time;
                    const amenitiesHTML = station.amenities.map(item => {
                        const itemJSON = JSON.stringify(item);
                        return `<button class="flex items-center space-x-2 bg-gray-100 p-2 rounded-lg" onclick='renderAmenityDetailsModal(${itemJSON})'>
                                    ${amenityIcons[item.type] || ''}
                                    <span class="text-sm font-medium text-gray-700">${item.name}</span>
                                </button>`;
                    }).join('');
                    return `
                    <li class="mb-10 ml-6">
                        <span class="absolute flex items-center justify-center w-6 h-6 bg-green-100 rounded-full -left-3 ring-8 ring-white">
                            <svg class="w-3 h-3 text-green-800" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22v-8"/><path d="M8.5 10.5 12 7l3.5 3.5"/><path d="M12 2v5"/></svg>
                        </span>
                         <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                            <div class="items-center justify-between mb-3 sm:flex">
                                <div class="text-sm font-normal text-gray-500">Dừng sạc tại <span class="font-semibold text-gray-900">${station.name}</span></div>
                            </div>
                            <div class="p-3 my-3 text-xs italic font-normal text-gray-500 border border-gray-200 rounded-lg bg-gray-50">
                                Sạc trong <span class="font-medium">${station.time} phút</span>. Chi phí ước tính: <span class="font-medium">${station.cost.toLocaleString('vi-VN')}đ</span>.
                            </div>
                             <div>
                                <h4 class="font-semibold mb-2 text-sm">Tiện ích xung quanh:</h4>
                                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">${amenitiesHTML}</div>
                            </div>
                        </div>
                    </li>
                    `;
                }
            }).join('');
            
            const finalEta = new Date(startTime.getTime() + cumulativeTime * 60000);
            
            mainContent.innerHTML = `
                <div id="journeyDetailsScreen" class="screen flex flex-col h-full relative">
                     <header class="flex items-center p-4">
                        <button onclick="renderResultsScreen()" class="p-2 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                        <h2 class="text-xl font-bold text-center flex-1">Chi tiết Hành trình</h2>
                        <div class="w-8"></div>
                    </header>
                    <div class="h-48 bg-gray-300 relative flex items-center justify-center">
                        <img src="https://placehold.co/400x192/d1d5db/4b5563?text=Map+Route+Hanoi+-+HCMC" class="w-full h-full object-cover" alt="Bản đồ hành trình">
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <h3 class="font-bold text-lg mb-4">Lộ trình sạc: Hà Nội - ${appState.request.destination}</h3>
                        <ol class="relative border-l border-gray-200">                  
                            ${stepsHTML}
                             <li class="ml-6">
                                <span class="absolute flex items-center justify-center w-6 h-6 bg-yellow-100 rounded-full -left-3 ring-8 ring-white">
                                    <svg class="w-3 h-3 text-yellow-800" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                </span>
                                <h3 class="text-lg font-semibold">Đến ${appState.request.destination}</h3>
                                <p class="text-sm text-gray-500">Dự kiến lúc: ${finalEta.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })} - ${finalEta.toLocaleDateString('vi-VN')}</p>
                            </li>
                        </ol>
                    </div>
                    <div class="p-4 bg-white mt-auto border-t">
                        <button class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700" onclick="renderConfirmJourneyBooking()">
                           Xác nhận & Đặt trước tất cả điểm sạc
                        </button>
                    </div>
                </div>
            `;
        };

        const renderAmenityDetailsModal = (amenity) => {
            const amenityIcons = {
                food: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M3 21h18v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2z"/><path d="M12 11a4 4 0 0 0-4 4v2h8v-2a4 4 0 0 0-4-4z"/><path d="M12 2v2"/><path d="M5 4.55a4 4 0 0 0-2 3.45v2h4v-2a4 4 0 0 0-2-3.45z"/><path d="M19 4.55a4 4 0 0 1 2 3.45v2h-4v-2a4 4 0 0 1 2-3.45z"/></svg>`,
                cafe: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-700"><path d="M10 21h4v-2a2 2 0 0 0-2-2h0a2 2 0 0 0-2 2v2z"/><path d="M20 8h-2.5a2.5 2.5 0 0 1 0-5h0A2.5 2.5 0 0 1 20 8z"/><path d="M4 8a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v8a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8z"/></svg>`,
                hotel: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M10 22v-6.57"/><path d="M12 11h.01"/><path d="M12 7h.01"/><path d="M14 15.43V22"/><path d="M15 4H9a2 2 0 0 0-2 2v12h10V6a2 2 0 0 0-2-2z"/><path d="M21 17h-2a2 2 0 0 0-2 2v3h4v-5z"/><path d="M3 17h2a2 2 0 0 1 2 2v3H3v-5z"/></svg>`,
                entertainment: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-500"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>`
            };
            const modal = document.createElement('div');
            modal.id = 'amenityModal';
            modal.className = 'absolute inset-0 bg-black/30 z-20 flex items-end';
            modal.setAttribute('onclick', 'closeAmenityModal()');
            modal.innerHTML = `
                <div class="w-full bg-white p-6 rounded-t-3xl shadow-lg modal-enter" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded-full flex-shrink-0">${amenityIcons[amenity.type]}</div>
                            <div>
                                <h3 class="text-xl font-bold">${amenity.name}</h3>
                                <p class="text-sm text-gray-500">Quán ăn • 50m • 2 phút đi bộ</p>
                            </div>
                        </div>
                        <button onclick="closeAmenityModal()" class="text-gray-400 text-2xl">&times;</button>
                    </div>
                    <div class="h-48 bg-gray-200 rounded-lg my-4 flex items-center justify-center">
                        <img src="https://placehold.co/300x192/e5e7eb/4b5563?text=Map+to+Amenity" class="w-full h-full object-cover rounded-lg" alt="Map to amenity">
                    </div>
                    <button class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">Chỉ đường</button>
                </div>
            `;
            document.querySelector('#journeyDetailsScreen').appendChild(modal);
        };

        const closeAmenityModal = () => {
            const modal = document.getElementById('amenityModal');
            if (modal) {
                const innerModal = modal.querySelector('.modal-enter');
                if (innerModal) {
                    innerModal.classList.remove('modal-enter');
                    innerModal.classList.add('modal-exit');
                }
                setTimeout(() => modal.remove(), 300);
            }
        };
        
        const renderConfirmJourneyBooking = () => {
            const journey = appState.booking.journey;
            const chargeStops = journey.steps.filter(step => step.type === 'charge');
            
            const stopsHTML = chargeStops.map(stop => {
                const station = mockStations[stop.stationId];
                return `
                    <div class="flex items-center justify-between py-2">
                        <p class="font-medium">${station.name}</p>
                        <span class="text-sm text-gray-500">${station.address.split(',').pop().trim()}</span>
                    </div>
                `;
            }).join('');

            mainContent.innerHTML = `
                 <div id="confirmJourneyBookingScreen" class="screen flex flex-col h-full">
                     <header class="flex items-center p-4">
                        <button onclick="renderJourneyDetailsScreen('${journey.id}')" class="p-2 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                        <h2 class="text-xl font-bold text-center flex-1">Xác nhận Hành trình</h2>
                        <div class="w-8"></div>
                    </header>
                    <div class="p-4 flex-1">
                        <h3 class="font-bold text-lg mb-2">Hệ thống sẽ đặt trước các điểm sạc sau:</h3>
                        <div class="bg-white p-4 rounded-xl border divide-y">
                            ${stopsHTML}
                        </div>
                        <div class="mt-6 text-xs text-gray-500 bg-gray-100 p-3 rounded-lg">
                            Các điểm sạc sẽ được giữ chỗ linh hoạt dựa trên tiến độ di chuyển thực tế của bạn. Bạn sẽ nhận được thông báo khi sắp đến điểm sạc.
                        </div>
                    </div>
                    <div class="p-4 bg-white mt-auto border-t">
                        <button class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700" onclick="startJourney()">
                           Bắt đầu hành trình
                        </button>
                    </div>
                 </div>
            `;
        };

        const startJourney = () => {
            appState.booking.currentStepIndex = 0; // Starting the first drive step
            renderDrivingScreen();
        };

        const resumeJourney = () => {
            appState.booking.currentStepIndex++; // Move index to the next drive step
            renderDrivingScreen();
        };

        const renderDrivingScreen = () => {
            const journey = appState.booking.journey;
            const currentDriveStep = journey.steps[appState.booking.currentStepIndex];
            const nextStep = journey.steps[appState.booking.currentStepIndex + 1];

            let destinationName, arrivalTime, buttonHTML;

            const driveDuration = currentDriveStep.duration;
            const arrivalDate = new Date(Date.now() + driveDuration * 60000);
            const arrivalTimeString = arrivalDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            if (nextStep && nextStep.type === 'charge') {
                // It's a leg to the next charging station
                const station = mockStations[nextStep.stationId];
                destinationName = station.name;
                buttonHTML = `<button class="w-full mt-2 bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700" onclick="arriveAtStation('${nextStep.stationId}')">
                               (Mô phỏng) Đã tới trạm sạc
                             </button>`;
            } else {
                // It's the final leg to the destination
                destinationName = appState.request.destination;
                buttonHTML = `<button class="w-full mt-2 bg-yellow-500 text-white font-bold py-3 rounded-xl hover:bg-yellow-600" onclick="renderJourneyCompleteScreen()">
                               (Mô phỏng) Đã tới đích
                             </button>`;
            }

            mainContent.innerHTML = `
                <div id="drivingScreen" class="screen flex flex-col h-full">
                    <header class="absolute top-0 left-0 right-0 z-10 flex items-center p-4">
                        <button onclick="renderJourneyDetailsScreen('${journey.id}')" class="p-2 rounded-full bg-white/80 backdrop-blur-sm shadow hover:bg-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                        </button>
                         <h2 class="text-lg font-semibold text-gray-800 bg-white/80 backdrop-blur-sm shadow py-2 px-4 rounded-full ml-2">Đang di chuyển...</h2>
                    </header>
                    <div class="flex-1 bg-gray-300 relative">
                         <img src="https://placehold.co/400x800/d1d5db/4b5563?text=Map+Driving+View" class="w-full h-full object-cover" alt="Bản đồ di chuyển">
                    </div>
                    <div id="driving-details-modal" class="bg-white p-4 rounded-t-3xl shadow-[0_-10px_30px_-15px_rgba(0,0,0,0.1)] absolute bottom-0 left-0 right-0">
                        <p class="text-sm font-medium text-blue-600">Điểm dừng tiếp theo</p>
                        <h3 class="text-xl font-bold">${destinationName}</h3>
                        <p class="text-sm text-gray-500">Dự kiến tới nơi lúc: <span class="font-bold text-green-600">${arrivalTimeString}</span></p>
                        
                        <div class="w-full bg-gray-200 rounded-full h-2.5 my-4">
                            <div id="drive-progress" class="bg-green-600 h-2.5 rounded-full progress-bar-fill" style="width: 1%"></div>
                        </div>
                        ${buttonHTML}
                    </div>
                </div>
            `;

            // Start simulation
            setTimeout(() => {
                const progressBar = document.getElementById('drive-progress');
                if (progressBar) progressBar.style.width = '100%';
            }, 100);
        };

        const arriveAtStation = (stationId) => {
            appState.booking.currentStepIndex++; // Move index to the charge step
            appState.booking.station = mockStations[stationId];
            renderBookedScreen();
        };
        
        const renderNearbyStationsScreen = () => {
             bottomNav.classList.add('hidden');
             appState.nearby.selectedStationId = null;

             const categories = {
                recommended: { name: 'Khuyên dùng', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`, color: 'yellow-500', textColor: 'black' },
                nearest: { name: 'Gần nhất', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>`, color: 'blue-500', textColor: 'white' },
                cheapest: { name: 'Rẻ nhất', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`, color: 'green-600', textColor: 'white' },
                fastest: { name: 'Nhanh nhất', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>`, color: 'orange-500', textColor: 'white' }
             };

             const categoryTabsHTML = Object.keys(categories).map(key => {
                const cat = categories[key];
                const isActive = key === appState.nearby.selectedCategory;
                 return `<button id="tab-${key}" class="flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold transition-colors ${isActive ? `bg-${cat.color} text-${cat.textColor}` : 'bg-gray-200 text-gray-700'}" onclick="filterNearbyStations('${key}')">${cat.icon} <span>${cat.name}</span></button>`;
             }).join('');

             mainContent.innerHTML = `
                <div id="nearbyScreen" class="screen flex flex-col h-full relative">
                     <header class="flex items-center p-4">
                        <button onclick="renderHomeScreen()" class="p-2 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                        <h2 class="text-xl font-bold text-center flex-1">Trạm sạc Gần đây</h2>
                        <div class="w-8"></div>
                    </header>
                    <div class="h-48 bg-gray-300 relative flex items-center justify-center">
                        <img src="https://placehold.co/400x192/d1d5db/4b5563?text=Bản+đồ+khu+vực+Chùa+Láng" class="w-full h-full object-cover" alt="Bản đồ khu vực Chùa Láng">
                    </div>
                    <div class="px-4 py-3">
                        <div class="flex gap-2 overflow-x-auto no-scrollbar">
                           ${categoryTabsHTML}
                        </div>
                    </div>
                    <div id="nearby-station-list" class="flex-1 overflow-y-auto p-4 pt-0 space-y-3">
                        <!-- Station cards will be rendered here -->
                    </div>
                    <div id="nearby-footer" class="p-4 bg-white mt-auto border-t">
                        <button id="nearby-booking-btn" class="w-full bg-gray-300 text-white font-bold py-3 rounded-xl transition-all" disabled onclick="renderDetailsScreen(appState.nearby.selectedStationId)">
                            Chọn & Đặt chỗ
                        </button>
                    </div>
                </div>
             `;
             filterNearbyStations(appState.nearby.selectedCategory);
        };

        const filterNearbyStations = (category) => {
            appState.nearby.selectedCategory = category;
            appState.nearby.selectedStationId = null; // Deselect station when changing category
            
             const categories = {
                recommended: { name: 'Khuyên dùng', color: 'yellow-500', textColor: 'black' },
                nearest: { name: 'Gần nhất', color: 'blue-500', textColor: 'white' },
                cheapest: { name: 'Rẻ nhất', color: 'green-600', textColor: 'white' },
                fastest: { name: 'Nhanh nhất', color: 'orange-500', textColor: 'white' }
             };

            // Update active tab style
            Object.keys(categories).forEach(key => {
                const tab = document.getElementById(`tab-${key}`);
                const cat = categories[key];
                if (key === category) {
                    tab.classList.add(`bg-${cat.color}`, `text-${cat.textColor}`);
                    tab.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    tab.classList.remove(`bg-${cat.color}`, `text-${cat.textColor}`);
                    tab.classList.add('bg-gray-200', 'text-gray-700');
                }
            });

            let stationList = Object.entries(mockStations).filter(([id, _]) => id.startsWith('st_') && !["st_vinh", "st_danang", "st_nhatrang"].includes(id));
            
            // Simple sorting logic for demo
            switch(category) {
                case 'recommended':
                    stationList.sort(([, a], [, b]) => b.rating - a.rating);
                    break;
                case 'nearest':
                    stationList.sort(([, a], [, b]) => parseFloat(a.distance) - parseFloat(b.distance));
                    break;
                case 'cheapest':
                    stationList.sort(([, a], [, b]) => a.cost - b.cost);
                    break;
                case 'fastest':
                    stationList.sort(([, a], [, b]) => a.time - b.time);
                    break;
            }

            const stationCardsHTML = stationList.map(([id, station]) => {
                const isSelected = id === appState.nearby.selectedStationId;
                return `
                    <div id="station-card-${id}" class="bg-white p-4 rounded-2xl border-2 ${isSelected ? 'border-green-600' : 'border-transparent'} shadow-sm cursor-pointer transition-all" onclick="selectNearbyStation('${id}')">
                        <div class="flex justify-between items-start">
                             <h3 class="font-bold text-lg text-gray-800">${station.name}</h3>
                              <button class="p-1 text-gray-400 hover:text-blue-600" onclick="event.stopPropagation(); renderStationDetailsModal('${id}')">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                              </button>
                        </div>
                        <div class="flex items-center space-x-1 mt-1 text-xs text-yellow-500">
                           <span>${station.rating}</span>
                           <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                        </div>
                        <div class="border-t my-3"></div>
                        <div class="flex justify-between text-sm">
                            <div class="text-center">
                                <p class="font-bold">${station.distance}</p>
                                <p class="text-xs text-gray-500">${station.travelTime}</p>
                            </div>
                            <div class="text-center">
                                <p class="font-bold">${station.time} phút</p>
                                <p class="text-xs text-gray-500">Sạc nhanh</p>
                            </div>
                            <div class="text-center">
                                <p class="font-bold text-green-600">${station.cost.toLocaleString('vi-VN')}đ</p>
                                <p class="text-xs text-gray-500">Ước tính</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('nearby-station-list').innerHTML = stationCardsHTML;
            updateNearbyBookingButton();
        };
        
        const selectNearbyStation = (stationId) => {
            appState.nearby.selectedStationId = stationId;

            // Update card styles
            document.querySelectorAll('#nearby-station-list > div').forEach(card => {
                card.classList.remove('border-green-600');
                card.classList.add('border-transparent');
            });
            document.getElementById(`station-card-${stationId}`).classList.add('border-green-600');
            
            updateNearbyBookingButton();
        };

        const updateNearbyBookingButton = () => {
            const btn = document.getElementById('nearby-booking-btn');
            if (appState.nearby.selectedStationId) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-300');
                btn.classList.add('bg-green-600');
                const station = mockStations[appState.nearby.selectedStationId];
                btn.textContent = `Chọn & Đặt chỗ - ${station.name}`;
            } else {
                btn.disabled = true;
                btn.classList.add('bg-gray-300');
                btn.classList.remove('bg-green-600');
                btn.textContent = 'Chọn & Đặt chỗ';
            }
        };

        const renderStationDetailsModal = (stationId) => {
            const station = mockStations[stationId];
            const modal = document.createElement('div');
            modal.id = 'stationDetailsModal';
            modal.className = 'absolute inset-0 bg-black/30 z-20 flex items-end';
            modal.setAttribute('onclick', 'closeStationDetailsModal()');

            const amenityIcons = {
                food: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M3 21h18v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2z"/><path d="M12 11a4 4 0 0 0-4 4v2h8v-2a4 4 0 0 0-4-4z"/><path d="M12 2v2"/><path d="M5 4.55a4 4 0 0 0-2 3.45v2h4v-2a4 4 0 0 0-2-3.45z"/><path d="M19 4.55a4 4 0 0 1 2 3.45v2h-4v-2a4 4 0 0 1 2-3.45z"/></svg>`,
                cafe: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-700"><path d="M10 21h4v-2a2 2 0 0 0-2-2h0a2 2 0 0 0-2 2v2z"/><path d="M20 8h-2.5a2.5 2.5 0 0 1 0-5h0A2.5 2.5 0 0 1 20 8z"/><path d="M4 8a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v8a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8z"/></svg>`,
                hotel: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M10 22v-6.57"/><path d="M12 11h.01"/><path d="M12 7h.01"/><path d="M14 15.43V22"/><path d="M15 4H9a2 2 0 0 0-2 2v12h10V6a2 2 0 0 0-2-2z"/><path d="M21 17h-2a2 2 0 0 0-2 2v3h4v-5z"/><path d="M3 17h2a2 2 0 0 1 2 2v3H3v-5z"/></svg>`,
                entertainment: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-500"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>`
            };
             const amenitiesHTML = station.amenities.map(item => `<div class="flex items-center space-x-2">${amenityIcons[item.type] || ''}<span class="text-sm font-medium text-gray-700">${item.name}</span></div>`).join('');
            
            modal.innerHTML = `
                 <div class="w-full bg-white max-h-[90%] flex flex-col rounded-t-3xl shadow-lg modal-enter" onclick="event.stopPropagation()">
                    <header class="p-4 flex-shrink-0">
                         <h3 class="text-xl font-bold">${station.name}</h3>
                         <p class="text-sm text-gray-500">${station.address}</p>
                    </header>
                    <div class="overflow-y-auto px-4 pb-4">
                        <div class="h-40 bg-gray-200 rounded-lg my-2"></div>
                        <h4 class="font-bold mt-4 mb-2">Tiện ích</h4>
                        <div class="space-y-2">${amenitiesHTML}</div>
                        <h4 class="font-bold mt-4 mb-2">Đánh giá</h4>
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <p class="font-semibold">"Trạm sạc nhanh, gần quán cafe tiện lợi."</p>
                            <p class="text-xs text-gray-500 mt-1">- Nguyễn Văn B, 2 ngày trước</p>
                        </div>
                    </div>
                     <div class="p-4 bg-white mt-auto border-t flex-shrink-0">
                        <button class="w-full bg-green-600 text-white font-bold py-3 rounded-xl" onclick="renderDetailsScreen('${stationId}')">Đặt chỗ tại trạm này</button>
                    </div>
                </div>
            `;
            document.querySelector('#nearbyScreen').appendChild(modal);
        };
        const closeStationDetailsModal = () => {
             const modal = document.getElementById('stationDetailsModal');
            if (modal) {
                const innerModal = modal.querySelector('.modal-enter');
                if (innerModal) innerModal.classList.add('modal-exit');
                setTimeout(() => modal.remove(), 300);
            }
        }


        const renderDetailsScreen = (stationId) => {
            appState.booking.journey = null;
            appState.booking.currentStepIndex = -1;
            appState.booking.station = mockStations[stationId];
            const station = appState.booking.station;
            
            const timeSlots = ['14:00', '14:30', '15:00', '15:30', '16:00', '16:30'].map(time => `
                <button class="time-slot-btn flex-shrink-0 px-4 py-2 border-2 border-gray-300 rounded-full text-gray-700 font-medium hover:border-green-600" onclick="selectTimeSlot(this, '${time}')">${time}</button>
            `).join('');

            mainContent.innerHTML = `
                <div id="detailsScreen" class="screen">
                     <header class="flex items-center p-4">
                        <button onclick="renderNearbyStationsScreen()" class="p-2 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                        <h2 class="text-xl font-bold text-center flex-1">Đặt chỗ sạc</h2>
                         <div class="w-8"></div>
                    </header>
                    <div class="p-4 pt-0">
                        <div class="bg-white p-4 rounded-xl border border-gray-200">
                             <h3 class="text-2xl font-bold text-gray-800">${station.name}</h3>
                             <p class="text-gray-500 mt-1">${station.address}</p>
                             <div class="flex items-center space-x-1 mt-2 text-sm text-yellow-500">
                                <span>${station.rating}</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-yellow-400"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                <span class="text-gray-400">(125 đánh giá)</span>
                            </div>
                        </div>
                        <div class="mt-6">
                            <h4 class="font-bold text-lg mb-3">Chọn khung giờ đến</h4>
                            <div class="flex space-x-3 overflow-x-auto pb-2 no-scrollbar">${timeSlots}</div>
                        </div>
                    </div>
                    <div id="confirm-footer" class="p-4 bg-white mt-auto sticky bottom-0 border-t">
                        <button id="confirm-booking-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl disabled:bg-gray-300" disabled onclick="renderConfirmScreen()">Chọn khung giờ</button>
                    </div>
                </div>
            `;
        };
        
         const selectTimeSlot = (element, time) => {
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                btn.classList.remove('bg-green-600', 'text-white', 'border-green-600');
                btn.classList.add('bg-transparent', 'text-gray-700', 'border-gray-300');
            });
            element.classList.add('bg-green-600', 'text-white', 'border-green-600');
            appState.booking.timeSlot = time;
            
            const confirmBtn = document.getElementById('confirm-booking-btn');
            confirmBtn.disabled = false;
            confirmBtn.textContent = `Đặt chỗ lúc ${time}`;
        };

        const renderConfirmScreen = () => {
             const station = appState.booking.station;
             const timeSlot = appState.booking.timeSlot;

             mainContent.innerHTML = `
                <div id="confirmScreen" class="screen flex flex-col h-full">
                     <header class="flex items-center p-4">
                        <button onclick="renderDetailsScreen('${Object.keys(mockStations).find(key => mockStations[key] === station)}')" class="p-2 rounded-full hover:bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                        </button>
                        <h2 class="text-xl font-bold text-center flex-1">Xác nhận đặt chỗ</h2>
                         <div class="w-8"></div>
                    </header>
                    <div class="p-4 flex-1">
                        <div class="space-y-3 text-base">
                            <div class="flex justify-between"><span class="text-gray-500">Trạm sạc:</span> <span class="font-semibold text-right">${station.name}</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Thời gian đến:</span> <span class="font-semibold">${timeSlot}</span></div>
                             <div class="flex justify-between"><span class="text-gray-500">Loại trụ:</span> <span class="font-semibold">Sạc nhanh DC</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Thời gian sạc (ước tính):</span> <span class="font-semibold">${station.time} phút</span></div>
                        </div>
                        <div class="my-6 border-t border-dashed"></div>
                         <div class="space-y-3 text-base">
                            <div class="flex justify-between"><span class="text-gray-500">Chi phí (ước tính):</span> <span class="font-semibold">${station.cost.toLocaleString('vi-VN')}đ</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Thanh toán qua:</span> <span class="font-semibold">Ví SmartWallet</span></div>
                            <div class="flex justify-between"><span class="text-gray-500">Số dư ví:</span> <span class="font-semibold">250.000đ</span></div>
                        </div>
                         <div class="mt-6 text-xs text-gray-500 bg-gray-100 p-3 rounded-lg">
                            Hệ thống sẽ giữ chỗ trong 15 phút. Vui lòng check-in đúng giờ.
                        </div>
                    </div>
                     <div class="p-4 bg-white mt-auto border-t">
                        <button class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700" onclick="renderBookedScreen()">
                            Xác nhận & Đặt chỗ
                        </button>
                    </div>
                </div>
             `;
        };
        
        const renderBookedScreen = () => {
            mainContent.innerHTML = `
                <div id="bookedScreen" class="screen flex flex-col items-center justify-center text-center p-6 h-full">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-12 h-12 text-green-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    </div>
                    <h2 class="text-2xl font-bold mt-4">Đặt chỗ thành công!</h2>
                    <p class="text-gray-500 mt-2">Sử dụng mã QR dưới đây để check-in tại trạm sạc.</p>
                    <div class="bg-white p-4 rounded-xl mt-8 shadow-md">
                        <img src="https://placehold.co/200x200/ffffff/111827?text=QR+Code" alt="QR Code">
                    </div>
                    <p class="mt-4 text-sm text-gray-600 font-medium">Chỗ của bạn đã được đảm bảo.</p>
                    <button class="mt-8 w-full bg-gray-800 text-white font-bold py-3 rounded-xl hover:bg-gray-900" onclick="renderChargingScreen()">
                        (Mô phỏng) Quét mã & Bắt đầu sạc
                    </button>
                </div>
            `;
        };
        
        const renderChargingScreen = (stationId) => {
            if (stationId) {
                appState.booking.station = mockStations[stationId];
            }
            let chargeSeconds = 0;
            let currentSOC = 15; // Assume SOC is low when arriving at charging station
            let energy = 0;
            const targetSOC = 80;
            const totalTime = appState.booking.station.time * 60; // in seconds
            const socPerSecond = (targetSOC - currentSOC) / totalTime;
            const costPerSecond = appState.booking.station.cost / totalTime;
            
            mainContent.innerHTML = `
                <div id="chargingScreen" class="screen flex flex-col h-full bg-gray-900 text-white p-6">
                    <h2 class="text-2xl font-bold text-center">Đang sạc...</h2>
                    <div class="flex-1 flex flex-col items-center justify-center">
                        <div class="relative w-48 h-48">
                            <svg class="w-full h-full" viewBox="0 0 36 36">
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#4a5568" stroke-width="3"/>
                                <path id="progress-circle" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#16A34A" stroke-width="3" stroke-dasharray="${currentSOC}, 100" stroke-linecap="round"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="soc-display" class="text-4xl font-bold">${currentSOC}%</span>
                                <span class="text-green-400">Đang nạp</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl space-y-3">
                         <div class="flex justify-between"><span class="text-gray-400">Thời gian sạc:</span> <span id="time-display" class="font-semibold">00:00</span></div>
                         <div class="flex justify-between"><span class="text-gray-400">Năng lượng đã nạp:</span> <span id="energy-display" class="font-semibold">0.0 kWh</span></div>
                         <div class="flex justify-between"><span class="text-gray-400">Chi phí (tạm tính):</span> <span id="cost-display" class="font-semibold">0đ</span></div>
                    </div>
                    <button class="mt-6 w-full bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-700" onclick="stopCharging()">
                        Dừng sạc
                    </button>
                </div>
            `;

            appState.simulationInterval = setInterval(() => {
                chargeSeconds++;
                currentSOC += socPerSecond;
                energy += (50 / totalTime); // Mock total energy of 50kWh
                if (currentSOC >= targetSOC) { stopCharging(); return; }
                const minutes = Math.floor(chargeSeconds / 60).toString().padStart(2, '0');
                const seconds = (chargeSeconds % 60).toString().padStart(2, '0');
                document.getElementById('time-display').textContent = `${minutes}:${seconds}`;
                document.getElementById('soc-display').textContent = `${Math.floor(currentSOC)}%`;
                document.getElementById('progress-circle').style.strokeDasharray = `${currentSOC}, 100`;
                document.getElementById('energy-display').textContent = `${energy.toFixed(1)} kWh`;
                document.getElementById('cost-display').textContent = `${Math.floor(costPerSecond * chargeSeconds).toLocaleString('vi-VN')}đ`;
            }, 100);
        };

        const stopCharging = () => {
             if (appState.simulationInterval) { clearInterval(appState.simulationInterval); appState.simulationInterval = null; renderCompletedScreen(); }
        };

        const renderCompletedScreen = () => {
             const isJourney = appState.booking.journey && appState.booking.currentStepIndex > -1;
             
             const buttonHTML = isJourney ?
                `<button class="mt-8 w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700" onclick="resumeJourney()">
                    Tiếp tục hành trình
                 </button>` :
                `<button class="mt-8 w-full bg-gray-800 text-white font-bold py-3 rounded-xl hover:bg-gray-900" onclick="renderHomeScreen()">
                    Quay về màn hình chính
                 </button>`;
            
            const subtitleText = isJourney ? 'Hành trình của bạn đã sẵn sàng để tiếp tục.' : 'Bạn đã sạc đầy năng lượng.';

             mainContent.innerHTML = `
                <div id="completedScreen" class="screen flex flex-col items-center justify-center text-center p-6 h-full">
                     <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-12 h-12 text-green-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    </div>
                    <h2 class="text-2xl font-bold mt-4">Sạc thành công!</h2>
                    <p class="text-gray-500 mt-1">${subtitleText}</p>
                    <div class="bg-white p-4 rounded-xl border border-gray-200 w-full mt-8 text-left space-y-2">
                        <h4 class="font-bold text-center mb-3">Biên lai điện tử</h4>
                        <div class="flex justify-between text-sm"><span class="text-gray-500">Trạm sạc:</span> <span class="font-medium text-right">${appState.booking.station.name}</span></div>
                        <div class="flex justify-between text-sm"><span class="text-gray-500">Tổng thời gian:</span> <span class="font-medium">${appState.booking.station.time} phút</span></div>
                        <div class="flex justify-between text-sm"><span class="text-gray-500">Tổng năng lượng:</span> <span class="font-medium">50.0 kWh</span></div>
                        <div class="border-t border-dashed my-2"></div>
                        <div class="flex justify-between text-lg"><span class="font-medium">Tổng chi phí:</span> <span class="font-bold text-green-600">${appState.booking.station.cost.toLocaleString('vi-VN')}đ</span></div>
                        <p class="text-xs text-center text-gray-400 pt-2">Đã thanh toán qua SmartWallet.</p>
                    </div>
                    ${buttonHTML}
                </div>
             `;
             
             // Reset booking state if it was a nearby charge or journey finished
             if (!isJourney) {
                appState.booking = {
                    journey: null, station: null, timeSlot: null, currentStepIndex: -1,
                };
             }
        };

        const renderJourneyCompleteScreen = () => {
             mainContent.innerHTML = `
                 <div id="journeyCompleteScreen" class="screen flex flex-col items-center justify-center text-center p-6 h-full">
                     <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center">
                         <svg class="w-12 h-12 text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 11.5 10 14.5 17 7.5"/><path d="M12 21.5a9.5 9.5 0 1 0 0-19 9.5 9.5 0 0 0 0 19z"/></svg>
                    </div>
                    <h2 class="text-2xl font-bold mt-4">Hoàn thành chuyến đi!</h2>
                    <p class="text-gray-500 mt-1">Bạn đã đến ${appState.request.destination} thành công.</p>
                    
                    <div class="w-full mt-8">
                        <h3 class="font-bold mb-3">Đánh giá trải nghiệm</h3>
                        <div id="rating-stars" class="flex justify-center items-center text-4xl text-gray-300">
                            <span class="rating-star" onmouseover="rate(1)" onclick="setRating(1)">★</span>
                            <span class="rating-star" onmouseover="rate(2)" onclick="setRating(2)">★</span>
                            <span class="rating-star" onmouseover="rate(3)" onclick="setRating(3)">★</span>
                            <span class="rating-star" onmouseover="rate(4)" onclick="setRating(4)">★</span>
                            <span class="rating-star" onmouseover="rate(5)" onclick="setRating(5)">★</span>
                        </div>
                    </div>

                    <button class="mt-8 w-full bg-gray-800 text-white font-bold py-3 rounded-xl hover:bg-gray-900" onclick="renderHomeScreen()">
                        Về trang chủ
                    </button>
                 </div>
            `;
            appState.booking = { journey: null, station: null, timeSlot: null, currentStepIndex: -1, };
        };

        const rate = (stars) => {
            const starElements = document.querySelectorAll('#rating-stars .rating-star');
            starElements.forEach((star, index) => {
                star.classList.toggle('text-yellow-400', index < stars);
                star.classList.toggle('text-gray-300', index >= stars);
            });
        };
        const setRating = (stars) => {
            // Here you would normally save the rating
            console.log(`User rated ${stars} stars.`);
            rate(stars); // Make it permanent on click
            document.getElementById('rating-stars').onmouseleave = null;
        }

        const renderHistoryScreen = () => {
            appState.currentScreen = 'history';
            updateNavActiveState('history');
            bottomNav.classList.remove('hidden');

            const historyTabs = {
                charging: { name: 'Đang sạc', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>`, color: 'green-600' },
                upcoming: { name: 'Sắp tới', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`, color: 'blue-500' },
                history: { name: 'Lịch sử', icon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>`, color: 'gray-500' },
            };

            const tabsHTML = Object.keys(historyTabs).map(key => {
                const tab = historyTabs[key];
                const isActive = key === appState.history.activeTab;
                return `<button id="history-tab-${key}" class="flex-1 flex justify-center items-center gap-2 pb-2 border-b-4 ${isActive ? `border-${tab.color} text-${tab.color}` : 'border-transparent text-gray-500'}" onclick="renderHistoryContent('${key}')">${tab.icon} <span class="font-semibold">${tab.name}</span></button>`;
            }).join('');

            mainContent.innerHTML = `
                 <div id="historyScreen" class="screen flex flex-col h-full relative">
                     <header class="p-4">
                        <h2 class="text-2xl font-bold text-gray-800">Hoạt động</h2>
                        <div class="flex mt-4 border-b">
                            ${tabsHTML}
                        </div>
                    </header>
                    <div id="history-content" class="flex-1 overflow-y-auto p-4 space-y-3">
                       <!-- Content will be rendered here -->
                    </div>
                 </div>
            `;
            renderHistoryContent(appState.history.activeTab);
        };

        const renderHistoryContent = (tab) => {
            appState.history.activeTab = tab;
            const contentEl = document.getElementById('history-content');
            
            // Re-render tabs to update active state
            const historyTabs = {
                charging: { color: 'green-600' },
                upcoming: { color: 'blue-500' },
                history: { color: 'gray-500' },
            };
            Object.keys(historyTabs).forEach(key => {
                const tabEl = document.getElementById(`history-tab-${key}`);
                const tabInfo = historyTabs[key];
                if (key === tab) {
                    tabEl.classList.add(`border-${tabInfo.color}`, `text-${tabInfo.color}`);
                    tabEl.classList.remove('border-transparent', 'text-gray-500');
                } else {
                    tabEl.classList.remove(`border-${tabInfo.color}`, `text-${tabInfo.color}`);
                    tabEl.classList.add('border-transparent', 'text-gray-500');
                }
            });


            if (tab === 'charging') {
                contentEl.innerHTML = `
                    <div class="bg-white p-4 rounded-lg border-l-4 border-green-500 shadow-sm cursor-pointer" onclick="renderChargingScreen('st_nct')">
                        <div class="flex items-start gap-4">
                             <svg class="w-16 text-gray-800 -mt-2" viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg">
                                <path d="M 10 70 C 5 50, 5 30, 30 30 L 170 30 C 195 30, 195 50, 190 70 L 180 90 L 20 90 Z" fill="#e5e7eb" stroke="#9ca3af" stroke-width="2"/>
                                <rect x="30" y="45" width="60" height="25" rx="5" fill="#d1d5db" />
                                <rect x="110" y="45" width="60" height="25" rx="5" fill="#d1d5db" />
                                <circle cx="40" cy="90" r="10" fill="#4b5563" />
                                <circle cx="160" cy="90" r="10" fill="#4b5563" />
                                <path d="M 100 20 L 105 10 L 110 20 L 105 30 Z" fill="#16a34a"/>
                            </svg>
                            <div class="flex-1">
                                <p class="font-semibold">EBOOST Vincom NCT</p>
                                <p class="text-sm font-bold text-green-600">45% • Còn 15 phút</p>
                                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                                    <div class="bg-green-600 h-1.5 rounded-full" style="width: 45%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tab === 'upcoming') {
                contentEl.innerHTML = `
                    <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500 shadow-sm cursor-pointer" onclick="renderHistoryDetailModal('upcoming', 'st_vinh')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 flex items-center justify-center bg-blue-100 text-blue-600 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                            </div>
                            <div>
                                <p class="font-semibold">ECharge Vinh</p>
                                <p class="text-sm text-gray-500">14:30 - Hôm nay, 19/10</p>
                            </div>
                        </div>
                    </div>
                     <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500 shadow-sm cursor-pointer" onclick="renderHistoryDetailModal('upcoming', 'st_danang')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 flex items-center justify-center bg-blue-100 text-blue-600 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                            </div>
                            <div>
                                <p class="font-semibold">Da Nang PowerUp</p>
                                <p class="text-sm text-gray-500">22:00 - Hôm nay, 19/10</p>
                            </div>
                        </div>
                    </div>
                `;
            } else { // history
                contentEl.innerHTML = `
                     <div class="bg-white p-4 rounded-lg border-l-4 border-gray-400 shadow-sm cursor-pointer" onclick="renderHistoryDetailModal('history', 'st_vinh')">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-600 rounded-full">
                               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            </div>
                            <div>
                                <p class="font-semibold">ECharge Vinh</p>
                                <p class="text-sm text-gray-500">15/10/2025 - 45 phút</p>
                            </div>
                             <p class="ml-auto font-bold text-red-600">-110.000đ</p>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg border-l-4 border-gray-400 shadow-sm cursor-pointer" onclick="renderHistoryDetailModal('history', 'st_cl')">
                        <div class="flex items-center gap-3">
                           <div class="w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-600 rounded-full">
                               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            </div>
                            <div>
                                <p class="font-semibold">Charge+ Chùa Láng</p>
                                <p class="text-sm text-gray-500">12/10/2025 - 30 phút</p>
                            </div>
                             <p class="ml-auto font-bold text-red-600">-65.000đ</p>
                        </div>
                    </div>
                `;
            }
        };
        
        const renderHistoryDetailModal = (type, stationId) => {
            const station = mockStations[stationId];
            const modal = document.createElement('div');
            modal.id = 'historyDetailModal';
            modal.className = 'absolute inset-0 bg-black/30 z-20 flex items-end';
            modal.setAttribute('onclick', 'closeHistoryDetailModal()');
            
            let contentHTML = '';
            if (type === 'upcoming') {
                contentHTML = `
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-gray-500">Trạng thái:</span> <span class="font-semibold text-blue-600">Sắp tới</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Thời gian:</span> <span class="font-semibold">14:30 - 19/10/2025</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Địa điểm:</span> <span class="font-semibold text-right">${station.address}</span></div>
                    </div>
                    <button class="w-full mt-4 border border-red-500 text-red-500 font-bold py-2 rounded-lg">Hủy đặt chỗ</button>
                `;
            } else { // history
                contentHTML = `
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span class="text-gray-500">Trạng thái:</span> <span class="font-semibold text-green-600">Hoàn thành</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Thời gian:</span> <span class="font-semibold">45 phút</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Năng lượng:</span> <span class="font-semibold">50.0 kWh</span></div>
                         <div class="border-t my-2"></div>
                        <div class="flex justify-between"><span class="text-gray-500">Tổng chi phí:</span> <span class="font-bold text-lg text-red-600">${station.cost.toLocaleString('vi-VN')}đ</span></div>
                    </div>
                    <button class="w-full mt-4 bg-gray-200 font-bold py-2 rounded-lg">Xem hóa đơn</button>
                `;
            }

            modal.innerHTML = `
                <div class="w-full bg-white p-6 rounded-t-3xl shadow-lg modal-enter" onclick="event.stopPropagation()">
                     <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold">${station.name}</h3>
                            <p class="text-sm text-gray-500">Chi tiết phiên sạc</p>
                        </div>
                        <button onclick="closeHistoryDetailModal()" class="text-gray-400 text-2xl">&times;</button>
                    </div>
                    ${contentHTML}
                </div>
            `;
            document.querySelector('#historyScreen').appendChild(modal);
        };
        const closeHistoryDetailModal = () => {
            const modal = document.getElementById('historyDetailModal');
            if(modal) {
                modal.querySelector('.modal-enter').classList.add('modal-exit');
                setTimeout(() => modal.remove(), 300);
            }
        };

        const renderWalletScreen = () => {
            appState.currentScreen = 'wallet';
            updateNavActiveState('wallet');
            bottomNav.classList.remove('hidden');
            mainContent.innerHTML = `
                 <div id="walletScreen" class="screen p-4">
                     <header class="flex items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Ví SmartWallet</h2>
                    </header>
                    <div class="bg-green-600 text-white p-6 rounded-2xl">
                        <p class="opacity-80">Số dư hiện tại</p>
                        <p class="text-4xl font-bold">250.000đ</p>
                        <button class="mt-4 bg-white/20 px-4 py-2 rounded-full font-semibold">Nạp tiền</button>
                    </div>
                    <h3 class="font-bold mt-6 mb-2">Giao dịch gần đây</h3>
                    <div class="space-y-3">
                        <div class="bg-white p-4 rounded-lg border flex justify-between items-center">
                            <div>
                                <p class="font-semibold">Sạc tại ECharge Vinh</p>
                                <p class="text-sm text-gray-500">15/10/2025</p>
                            </div>
                            <p class="font-bold text-red-600">-110.000đ</p>
                        </div>
                         <div class="bg-white p-4 rounded-lg border flex justify-between items-center">
                            <div>
                                <p class="font-semibold">Nạp tiền vào ví</p>
                                <p class="text-sm text-gray-500">10/10/2025</p>
                            </div>
                            <p class="font-bold text-green-600">+500.000đ</p>
                        </div>
                    </div>
                 </div>
            `;
        };
        const renderProfileScreen = () => {
            appState.currentScreen = 'profile';
            updateNavActiveState('profile');
            bottomNav.classList.remove('hidden');
            const activeCar = appState.user.cars.find(car => car.active);

            mainContent.innerHTML = `
                 <div id="profileScreen" class="screen p-4">
                     <header class="flex items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Hồ sơ</h2>
                    </header>
                    <div class="flex items-center space-x-4">
                        <div class="w-20 h-20 bg-gray-200 rounded-full"></div>
                        <div>
                            <h3 class="text-xl font-bold">${appState.user.name}</h3>
                            <p class="text-gray-500">${activeCar ? activeCar.name : 'Chưa có xe'}</p>
                        </div>
                    </div>
                    <div class="mt-6 bg-white p-4 rounded-lg border">
                        <div class="flex justify-between items-center">
                            <p class="font-semibold">TrustScore</p>
                            <p class="font-bold text-green-600 text-lg">95 / 100</p>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Điểm số cao giúp bạn đặt chỗ không cần cọc.</p>
                    </div>
                     <div class="mt-6 space-y-2">
                         <button class="w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center" onclick="renderEditProfileScreen()"><span>Thông tin cá nhân</span> <span>&gt;</span></button>
                         <button class="w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center" onclick="renderMyCarsScreen()"><span>Xe của tôi</span> <span>&gt;</span></button>
                         <button class="w-full text-left bg-white p-4 rounded-lg border flex justify-between items-center"><span>Cài đặt</span> <span>&gt;</span></button>
                         <button class="w-full text-left bg-white p-4 rounded-lg border text-red-600 font-semibold">Đăng xuất</button>
                    </div>
                 </div>
            `;
        };

        const renderEditProfileScreen = () => {
            bottomNav.classList.add('hidden');
            mainContent.innerHTML = `
                <div id="editProfileScreen" class="screen">
                    <header class="flex items-center p-4">
                        <button onclick="renderProfileScreen()" class="p-2 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                        <h2 class="text-xl font-bold text-center flex-1">Chỉnh sửa thông tin</h2>
                        <div class="w-8"></div>
                    </header>
                    <div class="p-4 space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-600">Họ và tên</label>
                            <input id="userNameInput" type="text" value="${appState.user.name}" class="w-full p-3 mt-1 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>
                         <div>
                            <label class="text-sm font-medium text-gray-600">Email</label>
                            <input id="userEmailInput" type="email" value="${appState.user.email}" class="w-full p-3 mt-1 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>
                         <div>
                            <label class="text-sm font-medium text-gray-600">Số điện thoại</label>
                            <input id="userPhoneInput" type="tel" value="${appState.user.phone}" class="w-full p-3 mt-1 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>
                    </div>
                    <div class="p-4 mt-auto">
                        <button class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700" onclick="saveProfileChanges()">Lưu thay đổi</button>
                    </div>
                </div>
            `;
        };

        const saveProfileChanges = () => {
            appState.user.name = document.getElementById('userNameInput').value;
            appState.user.email = document.getElementById('userEmailInput').value;
            appState.user.phone = document.getElementById('userPhoneInput').value;
            renderProfileScreen();
        };

        const renderMyCarsScreen = () => {
            bottomNav.classList.add('hidden');
            const carListHTML = appState.user.cars.map(car => `
                <div class="bg-white p-4 rounded-lg border flex justify-between items-center cursor-pointer" onclick="setActiveCar('${car.id}')">
                    <span class="font-medium">${car.name}</span>
                    ${car.active ? '<span class="text-xs font-bold text-white bg-green-500 px-2 py-1 rounded-full">ĐANG DÙNG</span>' : ''}
                </div>
            `).join('');

            mainContent.innerHTML = `
                <div id="myCarsScreen" class="screen">
                    <header class="flex items-center p-4">
                        <button onclick="renderProfileScreen()" class="p-2 rounded-full hover:bg-gray-100"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg></button>
                        <h2 class="text-xl font-bold text-center flex-1">Xe của tôi</h2>
                        <div class="w-8"></div>
                    </header>
                    <div class="p-4 space-y-3">
                        <p class="text-sm text-gray-500 px-1">Chọn xe bạn đang sử dụng để có đề xuất hành trình chính xác nhất.</p>
                        ${carListHTML}
                    </div>
                    <div class="p-4 mt-auto">
                        <button class="w-full border-2 border-gray-800 text-gray-800 font-bold py-3 rounded-xl hover:bg-gray-100">Thêm xe mới</button>
                    </div>
                </div>
            `;
        };

        const setActiveCar = (carId) => {
            appState.user.cars.forEach(car => {
                car.active = (car.id === carId);
            });
            renderMyCarsScreen();
        };

        // --- INITIALIZE APP ---
        document.addEventListener('DOMContentLoaded', () => {
            renderHomeScreen();
        });
    </script>
</body>
</html>

